<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Randompulse - Barang Random Pilihan</title>
    <meta name="description"
        content="Temukan barang-barang random, unik, dan estetik pilihan Randompulse. Affiliate terpercaya untuk produk gaya hidup, hobi, dan dekorasi.">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="theme-dark">
    <main class="min-h-screen pb-16 pt-6">
        <div class="mx-auto w-full max-w-[980px] px-4 app-shell">
            <!-- Top Bar -->
            <div class="flex items-center justify-between">
                <div class="text-lg font-semibold tracking-wide">Randompulse</div>
                <button id="themeToggle"
                    class="btn-3d rounded-lg bg-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-900">
                    Mode Gelap
                </button>
            </div>

            <!-- Header Banner -->
            <section class="panel mt-4 rounded-xl p-3 shadow-lg shadow-black/40">
                <div class="relative overflow-hidden rounded-xl">
                    <img src="https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=80"
                        alt="Randompulse banner" class="h-36 w-full object-cover sm:h-44 md:h-52">
                </div>
                <div class="panel-soft mt-4 flex flex-col gap-3 rounded-lg p-4 sm:flex-row sm:items-center sm:justify-between">
                    <div class="flex items-center gap-3">
                        <div class="avatar-shell h-12 w-12 rounded-full p-1">
                            <img src="logo/logo.jpg" alt="Randompulse avatar" class="h-full w-full rounded-full object-cover">
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="text-base font-semibold">Randompulse</span>
                                <span class="inline-flex h-4 w-4 items-center justify-center rounded-full bg-sky-500 text-[10px] text-white">✓</span>
                            </div>
                            <p class="text-xs text-slate-300">Kurasi barang random yang tetap worth it.</p>
                    <div class="mt-2 flex items-center gap-2 social-row">
                                <a href="https://instagram.com/randompulse" target="_blank"
                                    class="rounded-full bg-slate-700 px-2 py-1 text-[10px] font-semibold text-slate-200 hover:bg-slate-600">
                                    IG
                                </a>
                                <a href="https://www.tiktok.com/@randompulse" target="_blank"
                                    class="rounded-full bg-slate-700 px-2 py-1 text-[10px] font-semibold text-slate-200 hover:bg-slate-600">
                                    TT
                                </a>
                            </div>
                        </div>
                    </div>
                    <a href="https://facebook.com/randompulse" target="_blank"
                        class="btn-3d follow-btn inline-flex items-center justify-center rounded-lg border border-emerald-500/70 bg-emerald-500/20 px-4 py-2 text-xs font-semibold text-emerald-200">
                        Ikuti
                    </a>
                </div>
            </section>

            <!-- Body -->
            <section class="mt-6 grid items-start gap-4 md:grid-cols-[200px_1fr]">
                <!-- Menu -->
                <aside class="panel self-start rounded-xl p-4 shadow-lg shadow-black/30">
                    <button id="menuToggle"
                        class="flex w-full items-center justify-between text-xs font-semibold text-slate-300"
                        aria-expanded="true" aria-controls="menuItems">
                        <span>Menu</span>
                        <span id="menuChevron" class="text-slate-500">▾</span>
                    </button>
                    <div id="menuItems" class="mt-3 grid gap-2">
                        <button class="btn-3d menu-btn rounded-lg px-3 py-2 text-xs font-semibold">
                            Galeri
                        </button>
                        <button class="btn-3d menu-btn rounded-lg px-3 py-2 text-xs font-semibold">
                            Koleksi
                        </button>
                        <button class="btn-3d menu-btn rounded-lg px-3 py-2 text-xs font-semibold">
                            Favorit
                        </button>
                    </div>
                </aside>

                <!-- Content -->
                <div class="panel rounded-xl p-4 shadow-lg shadow-black/30">
                    <div class="flex flex-wrap items-center justify-between gap-3">
                        <h2 class="text-sm font-semibold">Galeri</h2>
                        <span class="text-[10px] font-semibold text-slate-400">Affiliate Picks</span>
                    </div>
                    <div class="mt-3">
                        <input id="searchInput" type="search" placeholder="Cari nama atau nomor produk..."
                            class="search-input w-full rounded-lg border border-slate-700/70 bg-slate-900/50 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 focus:border-sky-400 focus:outline-none">
                    </div>

                    <div id="galleryView" class="mt-4 transition-opacity duration-200">
                        <div id="productGrid" class="grid grid-cols-2 gap-3 sm:grid-cols-3"></div>
                        <div id="loadState" class="mt-4 text-center text-xs text-slate-400">Memuat data...</div>
                        <div id="pager" class="mt-3 flex flex-wrap gap-2"></div>
                    </div>

                    <div id="detailView" class="mt-4 hidden transition-opacity duration-200 opacity-0">
                        <button id="backBtn"
                            class="btn-3d mb-3 inline-flex items-center gap-2 rounded-md bg-rose-500 px-3 py-2 text-xs font-semibold text-white">
                            ← Kembali
                        </button>
                        <div class="content-card rounded-xl border p-3">
                            <div class="relative">
                                <img id="detailImage" src="" alt="" class="aspect-video w-full rounded-lg object-cover">
                                <button id="prevImage"
                                    class="btn-3d absolute left-0 top-0 h-full w-12 rounded-l-lg bg-slate-200/80 text-lg font-semibold text-slate-900">
                                    <
                                </button>
                                <button id="nextImage"
                                    class="btn-3d absolute right-0 top-0 h-full w-12 rounded-r-lg bg-slate-200/80 text-lg font-semibold text-slate-900">
                                    >
                                </button>
                            </div>
                            <div id="imageDots" class="mt-2 flex justify-center gap-1"></div>
                        </div>
                        <h3 id="detailTitle" class="mt-3 text-base font-semibold"></h3>
                        <p id="detailDesc" class="mt-2 text-sm text-slate-300"></p>
                        <div class="mt-3 flex items-center justify-between text-xs text-slate-400">
                        <span id="detailTag" class="tag-chip rounded-full px-2 py-1 font-semibold">Rp -</span>
                            <span class="uppercase tracking-wider">Produk</span>
                        </div>
                        <a id="detailLink" href="#" target="_blank"
                            class="btn-3d cta-btn mt-4 inline-flex w-full items-center justify-center rounded-lg px-4 py-3 text-xs font-semibold text-white">
                            Beli / Lihat di Shopee/Tokopedia
                        </a>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <style>
        body {
            background: #0f172a;
            color: #e2e8f0;
        }

        body.theme-light {
            background: #f2f4f8;
            color: #0f172a;
        }

        .panel {
            background: rgba(30, 41, 59, 0.9);
        }

        .panel-soft {
            background: rgba(30, 41, 59, 0.75);
        }

        .avatar-shell {
            background: rgba(51, 65, 85, 0.8);
        }

        .menu-btn {
            background: rgba(51, 65, 85, 0.7);
            color: #cbd5f5;
        }

        .menu-btn:first-child {
            background: rgba(56, 189, 248, 0.2);
            color: #bae6fd;
            box-shadow: inset 0 0 0 1px rgba(56, 189, 248, 0.5);
        }

        .content-card {
            background: rgba(15, 23, 42, 0.4);
            border-color: rgba(71, 85, 105, 0.6);
        }

        .tag-chip {
            background: rgba(51, 65, 85, 0.8);
        }

        .cta-btn {
            background: #3b82f6;
        }

        .cta-btn:hover {
            background: #60a5fa;
        }

        body.theme-light .panel,
        body.theme-light .panel-soft {
            background: #ffffff;
        }

        body.theme-light .avatar-shell,
        body.theme-light .menu-btn,
        body.theme-light .tag-chip {
            background: #e2e8f0;
            color: #1e293b;
        }

        body.theme-light .content-card {
            background: #f8fafc;
            border-color: #e2e8f0;
        }

        body.theme-light .menu-btn:first-child {
            background: #dbeafe;
            color: #1d4ed8;
            box-shadow: inset 0 0 0 1px #93c5fd;
        }

        body.theme-light .product-card {
            background: #f8fafc;
            border-color: #e2e8f0;
            color: #0f172a;
        }

        body.theme-light .product-card h3 {
            color: #0f172a;
        }

        body.theme-light .product-card .text-slate-400 {
            color: #64748b !important;
        }

        body.theme-light .social-row a {
            background: #e2e8f0;
            color: #1e293b;
        }

        body.theme-light .follow-btn {
            background: #10b981;
            color: #064e3b;
            border-color: #10b981;
        }

        body.theme-light .price-chip {
            background: #e2e8f0;
            color: #0f172a;
        }

        .btn-3d {
            position: relative;
            --btn-shadow-color: rgba(30, 64, 175, 0.7);
            transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
            box-shadow: 0 4px 0 var(--btn-shadow-color);
        }

        .btn-3d:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 var(--btn-shadow-color);
            filter: brightness(1.05);
        }

        .btn-3d:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 var(--btn-shadow-color);
        }

        #themeToggle {
            background: #3b82f6;
            color: #ffffff;
        }

        body.theme-light .text-slate-100,
        body.theme-light .text-slate-200 {
            color: #0f172a !important;
        }

        body.theme-light .text-slate-300,
        body.theme-light .text-slate-400,
        body.theme-light .text-slate-500 {
            color: #475569 !important;
        }

        body.theme-light .text-white {
            color: #f8fafc !important;
        }

        body.theme-light .search-input {
            background: #f8fafc;
            border-color: #e2e8f0;
            color: #0f172a;
        }
    </style>

    <script>
        const root = document.documentElement;
        const themeToggle = document.getElementById('themeToggle');
        const storedTheme = localStorage.getItem('rp_theme') || 'dark';

        const applyTheme = (mode) => {
            if (mode === 'light') {
                document.body.classList.add('theme-light');
                themeToggle.textContent = 'Mode Gelap';
            } else {
                document.body.classList.remove('theme-light');
                themeToggle.textContent = 'Mode Terang';
            }
            localStorage.setItem('rp_theme', mode);
        };

        applyTheme(storedTheme);
        themeToggle.addEventListener('click', () => {
            const next = document.body.classList.contains('theme-light') ? 'dark' : 'light';
            applyTheme(next);
        });

        const galleryView = document.getElementById('galleryView');
        const detailView = document.getElementById('detailView');
        const productGrid = document.getElementById('productGrid');
        const backBtn = document.getElementById('backBtn');
        const menuToggle = document.getElementById('menuToggle');
        const menuItems = document.getElementById('menuItems');
        const menuChevron = document.getElementById('menuChevron');
        const searchInput = document.getElementById('searchInput');
        const loadState = document.getElementById('loadState');
        const pager = document.getElementById('pager');

        let products = [];
        let page = 1;
        const limit = 20;
        let total = 0;
        let isLoading = false;

        const detailImage = document.getElementById('detailImage');
        const detailTitle = document.getElementById('detailTitle');
        const detailDesc = document.getElementById('detailDesc');
        const detailTag = document.getElementById('detailTag');
        const detailLink = document.getElementById('detailLink');
        const prevImageBtn = document.getElementById('prevImage');
        const nextImageBtn = document.getElementById('nextImage');
        const imageDots = document.getElementById('imageDots');

        let activeImages = [];
        let activeImageIndex = 0;

        const renderGrid = (items, { append = false } = {}) => {
            if (!append) productGrid.innerHTML = '';
            if (items.length === 0 && products.length === 0) {
                productGrid.innerHTML = '<p class="col-span-2 sm:col-span-3 text-xs text-slate-400">Tidak ada hasil.</p>';
                return;
            }
            const html = items.map((product) => `
                <button class="product-card group rounded-xl border border-slate-700/60 bg-slate-900/40 p-2 text-left hover:-translate-y-0.5 hover:border-sky-400/80 hover:shadow-md transition"
                    data-id="${product.id}">
                    <img src="${product.image}" alt="${product.title}" class="mb-2 h-24 w-full rounded-lg object-cover">
                    <div class="mb-1 text-[10px] font-semibold text-slate-400">No. ${product.number ?? '-'}</div>
                    <h3 class="text-xs font-semibold text-slate-100 line-clamp-2">${product.title}</h3>
                    <div class="mt-2 flex items-center justify-between text-[10px] text-slate-400">
                        <span class="price-chip rounded-full bg-slate-700 px-2 py-0.5 font-semibold">${product.price}</span>
                        <span class="uppercase tracking-wider">${product.tag}</span>
                    </div>
                </button>
            `).join('');
            productGrid.insertAdjacentHTML('beforeend', html);
        };

        const renderImageDots = () => {
            if (!imageDots) return;
            if (activeImages.length <= 1) {
                imageDots.innerHTML = '';
                return;
            }
            imageDots.innerHTML = activeImages.map((_, idx) => `
                <button class="h-1.5 w-1.5 rounded-full ${idx === activeImageIndex ? 'bg-sky-400' : 'bg-slate-500'}"
                    data-image-index="${idx}"></button>
            `).join('');
        };

        const setActiveImage = (index) => {
            if (!activeImages.length) return;
            activeImageIndex = (index + activeImages.length) % activeImages.length;
            detailImage.src = activeImages[activeImageIndex];
            renderImageDots();
        };

        const showDetail = (id) => {
            const product = products.find((item) => item.id === id);
            if (!product) return;
            activeImages = product.images && product.images.length ? product.images : [product.image];
            detailImage.alt = product.title;
            setActiveImage(0);
            detailTitle.textContent = product.title;
            detailDesc.textContent = product.description;
            detailTag.textContent = product.price;
            detailLink.href = product.link;

            galleryView.classList.add('opacity-0');
            setTimeout(() => {
                galleryView.classList.add('hidden');
                detailView.classList.remove('hidden');
                requestAnimationFrame(() => detailView.classList.remove('opacity-0'));
            }, 150);
        };

        const showGallery = () => {
            detailView.classList.add('opacity-0');
            setTimeout(() => {
                detailView.classList.add('hidden');
                galleryView.classList.remove('hidden');
                requestAnimationFrame(() => galleryView.classList.remove('opacity-0'));
            }, 150);
        };

        const renderPager = () => {
            const totalPages = Math.ceil(total / limit);
            if (!totalPages) {
                pager.innerHTML = '';
                return;
            }
            const buttons = [];
            const lastPage = totalPages;
            const windowSize = 7;
            let start = Math.max(2, page - Math.floor(windowSize / 2));
            let end = Math.min(lastPage - 1, start + windowSize - 1);
            start = Math.max(2, end - windowSize + 1);

            if (page > 1) {
                buttons.push(`
                    <button class="btn-3d rounded-md px-3 py-1 text-[10px] font-semibold bg-slate-200 text-slate-900"
                        data-first="true">
                        First
                    </button>
                    <button class="btn-3d rounded-md px-3 py-1 text-[10px] font-semibold bg-slate-200 text-slate-900"
                        data-prev="true">
                        Prev
                    </button>
                `);
            }

            const isFirstActive = page === 1;
            buttons.push(`
                <button class="btn-3d rounded-md px-3 py-1 text-[10px] font-semibold ${isFirstActive ? 'bg-sky-500 text-white' : 'bg-slate-200 text-slate-900'}"
                    data-page="1">
                    1
                </button>
            `);

            if (start > 2) {
                buttons.push('<span class="px-2 text-[10px] text-slate-400">...</span>');
            }

            for (let i = start; i <= end; i += 1) {
                const isActive = i === page;
                buttons.push(`
                    <button class="btn-3d rounded-md px-3 py-1 text-[10px] font-semibold ${isActive ? 'bg-sky-500 text-white' : 'bg-slate-200 text-slate-900'}"
                        data-page="${i}">
                        ${i}
                    </button>
                `);
            }

            if (end < lastPage - 1) {
                buttons.push('<span class="px-2 text-[10px] text-slate-400">...</span>');
            }

            if (lastPage > 1) {
                const isLastActive = page === lastPage;
                buttons.push(`
                    <button class="btn-3d rounded-md px-3 py-1 text-[10px] font-semibold ${isLastActive ? 'bg-sky-500 text-white' : 'bg-slate-200 text-slate-900'}"
                        data-page="${lastPage}">
                        ${lastPage}
                    </button>
                `);
            }

            if (page < lastPage) {
                buttons.push(`
                    <button class="btn-3d rounded-md px-3 py-1 text-[10px] font-semibold bg-slate-200 text-slate-900"
                        data-next="true">
                        Next
                    </button>
                `);
            }

            pager.innerHTML = buttons.join('');
        };

        const fetchProducts = async ({ reset = false } = {}) => {
            if (isLoading) return;
            isLoading = true;
            loadState.textContent = 'Memuat data...';
            loadState.classList.remove('hidden');
            pager.classList.add('hidden');

            if (reset) {
                page = 1;
                products = [];
                renderGrid([]);
            }

            try {
                const q = searchInput.value.trim();
                const params = new URLSearchParams({
                    page: String(page),
                    limit: String(limit)
                });
                if (q) params.set('q', q);
                const res = await fetch(`/api/products?${params.toString()}`);
                const json = await res.json();
                const items = (json.items || []).map((item) => ({
                    id: item.id,
                    number: item.productNumber,
                    title: item.name || '',
                    price: item.price || '',
                    tag: 'Produk',
                    images: Array.isArray(item.images) && item.images.length
                        ? item.images
                        : (item.image ? [item.image] : []),
                    image: item.image || 'https://placehold.co/400x400/eee/333?text=No+Image',
                    description: item.description || '',
                    link: item.link || '#'
                }));
                total = json.total || 0;
                products = reset ? items : products.concat(items);
                renderGrid(items, { append: false });
                if (total > 0) {
                    loadState.classList.add('hidden');
                } else {
                    loadState.textContent = 'Tidak ada hasil.';
                }
                renderPager();
                pager.classList.remove('hidden');
            } catch (error) {
                loadState.textContent = 'Gagal memuat data.';
            } finally {
                isLoading = false;
            }
        };

        productGrid.addEventListener('click', (event) => {
            const card = event.target.closest('[data-id]');
            if (!card) return;
            showDetail(card.dataset.id);
        });

        backBtn.addEventListener('click', showGallery);
        prevImageBtn.addEventListener('click', () => setActiveImage(activeImageIndex - 1));
        nextImageBtn.addEventListener('click', () => setActiveImage(activeImageIndex + 1));
        imageDots.addEventListener('click', (event) => {
            const btn = event.target.closest('[data-image-index]');
            if (!btn) return;
            setActiveImage(Number(btn.dataset.imageIndex));
        });

        let touchStartX = 0;
        let touchEndX = 0;
        detailImage.addEventListener('touchstart', (event) => {
            touchStartX = event.changedTouches[0].clientX;
        });
        detailImage.addEventListener('touchend', (event) => {
            touchEndX = event.changedTouches[0].clientX;
            const delta = touchEndX - touchStartX;
            if (Math.abs(delta) < 30) return;
            if (delta > 0) {
                setActiveImage(activeImageIndex - 1);
            } else {
                setActiveImage(activeImageIndex + 1);
            }
        });
        menuToggle.addEventListener('click', () => {
            const isOpen = menuItems.classList.contains('hidden') === false;
            menuItems.classList.toggle('hidden');
            menuToggle.setAttribute('aria-expanded', String(!isOpen));
            menuChevron.textContent = isOpen ? '▸' : '▾';
        });

        let searchTimer = null;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => fetchProducts({ reset: true }), 300);
        });

        pager.addEventListener('click', (event) => {
            const nextBtn = event.target.closest('[data-next]');
            if (nextBtn) {
                page += 1;
                fetchProducts({ reset: false });
                return;
            }
            const prevBtn = event.target.closest('[data-prev]');
            if (prevBtn) {
                page = Math.max(1, page - 1);
                fetchProducts({ reset: false });
                return;
            }
            const firstBtn = event.target.closest('[data-first]');
            if (firstBtn) {
                page = 1;
                fetchProducts({ reset: false });
                return;
            }
            const btn = event.target.closest('[data-page]');
            if (!btn) return;
            const nextPage = Number(btn.dataset.page);
            if (!Number.isFinite(nextPage) || nextPage === page) return;
            page = nextPage;
            fetchProducts({ reset: false });
        });

        fetchProducts({ reset: true });
    </script>
</body>

</html>
